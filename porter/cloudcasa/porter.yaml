schemaVersion: 1.0.0-alpha.1
name: cloudcasa
registry: catalogicsoftware
#registry: cnabquickstarts.azurecr.io/porter
version: 3.2.0
description: "Kubernetes data protection service"
dockerfile: Dockerfile.tmpl
maintainers:
- name: "Catalogic Software"
  email: "support@cloudcasa.io"
  url: "https://cloudcasa.io"

credentials:
  - name: kubeconfig
    path: /home/nonroot/.kube/config

parameters:
  - name: cluster_id
    default: ''
    type: string
    description: Provide cluster_id to register the K8S cluster with CloudCasa
    applyTo:
      - install
      - upgrade
      - uninstall
  - name: installation_name
    type: string
    default: cloudcasa
    description: Installation name for the deployment
    destination:
      env: $INSTALLATION_NAME

mixins:
  - exec
  - kubernetes

install:
  - exec:
      description: "Substituting cluster_id value to manifest"
      command: ./helpers.sh
      arguments:
        - install
        - "{{ bundle.parameters.cluster_id }}"
  - kubernetes:
      description: "Register the cluster with CloudCasa"
      manifests:
      - /cnab/app/km.yaml
      wait: true

upgrade:
  - exec:
      description: "Substituting cluster_id value to manifest"
      command: ./helpers.sh
      arguments:
        - install
        - "{{ bundle.parameters.cluster_id }}"
  - kubernetes:
      description: "Upgrade the cluster kubeagent"
      manifests:
      - /cnab/app/km.yaml
      wait: true

uninstall:
  - exec:
      description: "Substituting cluster_id value to manifest"
      command: ./helpers.sh
      arguments:
        - uninstall
        - "{{ bundle.parameters.cluster_id }}"
  - kubernetes:
      description: "Unregister the cluster with CloudCasa"
      manifests:
      - /cnab/app/km.yaml
      wait: true
